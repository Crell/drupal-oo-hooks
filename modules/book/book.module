<?php

$module = array("find" => "book_find",
                "page" => "book_page",
                "user" => "book_user",
                "admin" => "book_admin");

class Book {
  function Book($nid, $userid, $title, $body, $parent, $weight, $timestamp) {
    $this->nid = $nid;
    $this->userid = $userid;
    $this->title = $title;
    $this->body = $body;
    $this->parent = $parent;
    $this->weight = $weight;
    $this->timestamp = $timestamp;
  }
}

function book_post_threshold($node, $default) {
  return $default;
}

function book_dump_threshold($node, $default) {
  return $default;
}

function book_timout_threshold($node, $default) {
  return $default;
}

function book_status() {
  return array(dumped, expired, queued, posted);
}

function book_location($node, $nodes = array()) {
  $parent = db_fetch_object(db_query("SELECT n.nid, n.title, b.parent FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE n.nid = '$node->parent'"));
  if ($parent->title) {
    $nodes = book_location($parent, $nodes);
    array_push($nodes, $parent);
  }
  return $nodes;
}

function book_view($node, $page = 1) {
  global $theme;

  if ($node->nid && $node->parent) {
    $next = db_fetch_object(db_query("SELECT n.nid, n.title FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE b.parent = '$node->parent' AND b.weight > '$node->weight' ORDER BY b.weight ASC"));
    $prev = db_fetch_object(db_query("SELECT n.nid, n.title FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE b.parent = '$node->parent' AND b.weight < '$node->weight' ORDER BY b.weight DESC"));
  }

  $output .= "<TABLE BORDER=\"0\" CELLPADDING=\"0\" CELLSPACING=\"0\" WIDTH=\"100%\">\n";

  if ($node->title) {
    foreach (book_location($node) as $level) {
      $location .= "$indent <A HREF=\"node.php?id=$level->nid\">$level->title</A><BR>";
      $indent .= "-";
    }

    $output .= " <TR><TD COLSPAN=\"2\">$location</TD><TD ALIGN=\"right\">". node_control($node) ."</TD></TR>\n";
    $output .= " <TR><TD COLSPAN=\"3\"><HR></TD</TR>";
    $output .= " <TR><TD COLSPAN=\"3\"><B><BIG>". check_output($node->title) ."</BIG></B>". ($node->body ? "<BR><SMALL><I>Last updated by ". format_username($node->userid) ." on ". format_date($node->timestamp) ."</I></SMALL> " : "") ."</TD></TR>\n";
  }

  if ($node->body) {
    $output .= " <TR><TD COLSPAN=\"3\"><BR>". check_output($node->body, 1) ."</TD></TR>";
  }

  $output .= " <TR><TD COLSPAN=\"3\"><BR>". book_tree($node->nid) ."</TD</TR>";
  $output .= " <TR><TD COLSPAN=\"3\"><HR></TD</TR>";
  $output .= " <TR><TD ALIGN=\"left\" WIDTH=\"33%\">". ($prev ? "<A HREF=\"node.php?id=$prev->nid\">". t("previous") ."</A>" : t("previous")) ."</TD><TD ALIGN=\"center\" WIDTH=\"34%\"><A HREF=\"module.php?mod=book\">index</A></TD><TD ALIGN=\"right\" WIDTH=\"33%\">". ($next ? "<A HREF=\"node.php?id=$next->nid\">". t("next") ."</A>" : t("next")) ."</TD></TR>\n";
  $output .= " <TR><TD ALIGN=\"left\" WIDTH=\"33%\">". ($prev ? "<SMALL>". check_output($prev->title) ."</SMALL>" : "&nbsp;") ."</TD><TD ALIGN=\"center\" WIDTH=\"34%\">". ($node->parent ? "<A HREF=\"node.php?id=$node->parent\">". t("up") ."</A>" : t("up")) ."</TD><TD ALIGN=\"right\" WIDTH=\"33%\">". ($next ? "<SMALL>". check_output($next->title) ."</SMALL>" : "&nbsp;") ."</TD></TR>\n";
  $output .= "</TABLE>\n";

  if ($page) $theme->header();
  $theme->box(t("Book"), $output);
  if ($page) $theme->footer();
}

function book_find($keys) {
  global $status, $user;
  $find = array();
  $result = db_query("SELECT n.*, u.userid FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid LEFT JOIN users u ON n.author = u.id WHERE n.type = 'book' AND n.status = '$status[posted]' AND (n.title LIKE '%". check_input($keys) ."%' OR b.body LIKE '%". check_input($keys) ."%') ORDER BY n.timestamp DESC LIMIT 20");
  while ($node = db_fetch_object($result)) {
    array_push($find, array("title" => check_output($node->title), "link" => (user_access($user, "book") ? "admin.php?mod=book&op=edit&id=$node->nid" : "node.php?id=$node->nid"), "user" => $node->userid, "date" => $node->timestamp));
  }
  return $find;
}

function book_toc($parent = 0, $indent = "", $toc = array()) {
  global $status;
  $result = db_query("SELECT n.*, b.* FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE n.type = 'book' AND n.status = '$status[posted]' AND b.parent = '$parent' ORDER BY b.weight");
  while ($node = db_fetch_object($result)) {
    $toc[$node->nid] = "$indent $node->title";
    if ($node->pid) $toc = book_toc($node->pid, "$indent-", $toc);
    $toc = book_toc($node->nid, "$indent-", $toc);
  }
  return $toc;
}

function book_form($edit = array()) {
  global $allowed_html, $PHP_SELF, $REQUEST_URI, $user;

  $output .= "<FORM ACTION=\"$REQUEST_URI\" METHOD=\"post\">\n";

  $output .= "<B>". t("Author") .":</B><BR>\n";
  $output .= "<INPUT TYPE=\"hidden\" NAME=\"edit[userid]\" VALUE=\"$edit[userid]\">\n";
  $output .= format_username(($edit[userid] ? $edit[userid] : $user->userid)) ."<P>\n";

  if ($edit[pid]) {
    $node = node_get_object("nid", $edit[pid]);
    $output .= "<B>". t("Parent") .":</B><BR>\n";
    $output .= "<A HREF=\"node.php?id=$node->id\">". check_output($node->title) ."</A><P>\n";
    $output .= "<INPUT TYPE=\"hidden\" NAME=\"edit[parent]\" VALUE=\"$edit[parent]\">\n";
    $output .= "<SMALL><I>". t("The parent subject or category the page belongs in.") ."</I></SMALL><P>\n";
  }
  else {
    $output .= "<B>". t("Parent") .":</B><BR>\n";
    foreach (book_toc() as $key=>$value) $options2 .= "<OPTION VALUE=\"$key\"". ($edit[parent] == $key ? " SELECTED" : "") .">". check_select($value) ."</OPTION>";
    if (user_access($user, "book")) $options2 .= "<OPTION VALUE=\"0\"". ($edit[parent] == 0 ? " SELECTED" : "") .">&nbsp;</OPTION>";
    $output .= "<SELECT NAME=\"edit[parent]\">$options2</SELECT><BR>\n";
    $output .= "<SMALL><I>". t("The parent subject or category the page belongs in.") ."</I></SMALL><P>\n";
  }

  $output .= "<B>". t("Subject") .":</B><BR>\n";
  $output .= "<INPUT TYPE=\"text\" NAME=\"edit[title]\" SIZE=\"50\" MAXLENGTH=\"128\" VALUE=\"". check_textfield($edit[title]) ."\"><P>\n";

  $output .= "<B>". t("Content") .":</B><BR>\n";
  $output .= "<TEXTAREA WRAP=\"virtual\" COLS=\"50\" ROWS=\"10\" NAME=\"edit[body]\" MAXLENGTH=\"20\">". check_textarea($edit[body]) ."</TEXTAREA><BR>\n";
  $output .= "<SMALL><I>". t("Allowed HTML tags") .": ". htmlspecialchars($allowed_html) .".</I></SMALL><P>\n";

  $output .= "<B>". t("Log message") .":</B><BR>\n";
  $output .= "<TEXTAREA WRAP=\"virtual\" COLS=\"50\" ROWS=\"5\" NAME=\"edit[log]\" MAXLENGTH=\"20\">". check_textarea($edit[log]) ."</TEXTAREA><BR>\n";
  $output .= "<SMALL><I>". t("An explanation of the additions or updates being made to help the group understand your motivations.") ."</I></SMALL><P>\n";

  if (user_access($user, "book")) {
    $output .= "<B>". t("Weight") .":</B><BR>\n";
    for ($count = 0; $count < 25; $count++) $options3 .= "<OPTION VALUE=\"$count\"". ($edit[weight] == $count ? " SELECTED" : "") .">$count</OPTION>";
    $output .= "<SELECT NAME=\"edit[weight]\">$options3</SELECT><BR>\n";
    $output .= "<SMALL><I>". t("The heavier nodes will sink and the lighter nodes will be positioned nearer the top.") ."</I></SMALL><P>\n";
  }

  if (!$edit) {
    $output .= "<INPUT TYPE=\"submit\" NAME=\"op\" VALUE=\"". t("Preview") ."\">\n";
  }
  else if (!$edit[title]) {
    $output .= "<FONT COLOR=\"red\">". t("Warning: you did not supply a title.") ."</FONT><P>\n";
    $output .= "<INPUT TYPE=\"submit\" NAME=\"op\" VALUE=\"". t("Preview") ."\">\n";
  }
  else {
    $output .= "<INPUT TYPE=\"submit\" NAME=\"op\" VALUE=\"". t("Preview") ."\">\n";
    $output .= "<INPUT TYPE=\"submit\" NAME=\"op\" VALUE=\"". t("Submit") ."\">\n";
  }

  $output .= "<INPUT TYPE=\"hidden\" NAME=\"edit[pid]\" VALUE=\"$edit[pid]\">\n";
  $output .= "<INPUT TYPE=\"hidden\" NAME=\"edit[nid]\" VALUE=\"$edit[nid]\">\n";

  $output .= "</FORM>\n";

  return $output;
}

function book_save($edit) {
  node_save(array_diff(array_merge($edit, array(nid => $edit[nid], type => "book")), array(userid => $edit[userid])));
}

function book_tree($parent = "", $depth = 0) {
  global $PHP_SELF, $status;

  if (($depth < 3) || ($PHP_SELF == "/admin.php")) {
    $result = db_query("SELECT n.*, b.* FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE n.type = 'book' AND n.status = '$status[posted]' AND b.parent = '$parent' ORDER BY b.weight");
    $output .= "<UL>";
    while ($node = db_fetch_object($result)) {
      $output .= "<LI><A HREF=\"node.php?id=$node->nid\">". check_output($node->title) ."</A>";
      if ($PHP_SELF == "/admin.php") $output .= " <SMALL>(weight: $node->weight/$node->parent, status: $node->status) (<A HREF=\"admin.php?mod=book&op=edit&id=$node->nid\">edit</A>)</SMALL>\n";
      if ($node->pid) $output .= book_tree($node->pid, $depth + 1);
      $output .= book_tree($node->nid, $depth + 1);
    }
    $output .= "</UL>";
  }
  return $output;
}

function book_list($query = array()) {
  return node_overview($query);
}

function book_query($type = "") {
  global $status;
  $queries =  array(0 => array("active book pages", "WHERE n.type = 'book' ORDER BY n.timestamp DESC"), 1 => array("posted book pages", "WHERE n.type = 'book' AND n.status = '$status[posted]' ORDER BY n.timestamp DESC"), 2 => array("queued book pages", "WHERE n.type = 'book' AND n.status = '$status[queued]' ORDER BY n.timestamp DESC"), 3 => array("dumped book pages", "WHERE n.type = 'book' AND n.status = '$status[dumped]' ORDER BY n.timestamp DESC"));
  return ($queries[$type] ? $queries[$type] : $queries);
}

function book_listing() {
  foreach (book_query() as $key=>$array) {
    $output .= "<LI><A HREF=\"admin.php?mod=book&type=$key\">$array[0]</A></LI>\n";
  }
  return "<OL>$output</OL>\n";
}


function book_admin() {
  global $op, $id, $edit, $mod, $keys, $type, $user;

  print "<SMALL><A HREF=\"admin.php?mod=book&op=add\">add new page</A> | <A HREF=\"admin.php?mod=book&op=listing\">book listing</A> | <A HREF=\"admin.php?mod=book&op=search\">search book</A> | <A HREF=\"admin.php?mod=book\">list overview</A> | <A HREF=\"admin.php?mod=book&op=tree\">tree overview</A></SMALL><HR>\n";

  $type = $type ? $type : 0;

  switch ($op) {
    case "add":
      print book_form();
      break;
    case "edit":
      print book_form(node_get_array(nid, $id));
      break;
    case "listing":
      print book_listing();
      break;
    case "search":
      print search_form($keys);
      print search_data($keys, $mod);
      break;
    case "tree":
      print book_tree();
      break;
    case t("Preview"):
      book_view(new Book(($edit[nid] ? $edit[nid] : -1), ($edit[userid] ? $edit[userid] : $user->userid), $edit[title], $edit[body], $edit[parent], $edit[weight], ($edit[timestamp] ? $edit[timestamp] : time())), 0);
      print book_form($edit);
      break;
    case t("Submit"):
      book_save($edit);
      // fall through:
    default:
      print book_list(book_query($type));
  }
}

function book_page() {
  global $status, $theme;

  $result = db_query("SELECT n.*, b.* FROM node n LEFT JOIN book b ON n.nid = b.nid AND n.lid = b.lid WHERE b.parent = 0 AND n.status = $status[posted] ORDER BY b.weight");

  while ($node = db_fetch_object($result)) {
    $output .= "<DT><A HREF=\"node.php?id=$node->nid\">". check_output($node->title) ."</A></DT><DD>". check_output($node->body, 1) ."<BR><BR></DD>";
  }

  $theme->header();
  $theme->box(t("Book"), "<DL>$output</DL>");
  $theme->footer();
}

function book_update($id) {
  global $status;

  if ($node = node_get_object("nid", $id)) {
    if ($node->status != $status[posted]) {
      return t("You can only update accepted pages: pages that are still queued or already expired can not be updated.");
    }
    else if (db_result(db_query("SELECT COUNT(nid) FROM node WHERE pid = '$node->nid' AND status = '$status[queued]'"))) {
      return t("There is already an update for this node in the queue: we can only process one update at once.");
    }
    else {
      return book_form(array(nid => -1, pid => $id, title => $node->title, body => $node->body, parent => $node->parent));
    }
  }
}

function book_user() {
  global $edit, $id, $op, $theme, $user;

  $title = t("Submit a book page");

  switch($op) {
    case "update":
      $theme->box($title, book_update($id));
      break;
    case t("Preview"):
      book_view(new Book(($edit[nid] ? $edit[nid] : -1), $user->userid, $edit[title], $edit[body], $edit[parent], $edit[weight], ($edit[timestamp] ? $edit[timestamp] : time())), 0);
      $theme->box($title, book_form($edit));
      break;
    case t("Submit"):
      book_save($edit);
      $theme->box($title, t("Thank you for your submission."));
      break;
    default:
      $theme->box($title, book_form());
  }
}

?>
