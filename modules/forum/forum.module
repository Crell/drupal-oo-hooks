<?php

function forum_status() {
  return array(dumped, posted);
}

function forum_view($node) {
  global $theme;
  $output .= "<P><A HREF=\"module.php?mod=forum\">". t("Forum") ."</A> / <B><A HREF=\"node.php?id=$node->nid\">". check_output($node->title) ."</A></B>:</P><P>". check_output($node->body) ."</P>";
  $theme->box(t("Discussion forum"), $output);
}

function forum_form($edit = array()) {
  global $REQUEST_URI;

  $form .= form_textfield("Subject", "title", $edit[title], 50, 64);
  $form .= form_textarea("Body", "body", $edit[body], 70, 10);
  $form .= form_hidden("nid", $edit[nid]);
  $form .= form_submit("Submit");

  return form($REQUEST_URI, $form);
}

function forum_save($edit) {
  global $user, $status;

  node_save($edit, array(author => $user->id, body, comment => 1, moderate => variable_get("forum_moderate", ""), promote => variable_get("forum_promote", 0), score => 0, status => $status[posted], timestamp => time(), title, type => "forum", votes => 0));
}

function forum_num_comments($nid) {
  $value = db_fetch_object(db_query("SELECT COUNT(cid) AS count FROM comments WHERE lid = '$nid'"));
  return ($value) ? $value->count : 0;
}

function forum_last_comment($nid) {
  $value = db_fetch_object(db_query("SELECT timestamp FROM comments WHERE lid = '$nid' ORDER BY timestamp DESC LIMIT 1"));
  return ($value) ? format_date($value->timestamp, "small") : "&nbsp;";
}

function forum_page() {
  global $user, $theme;

  if (user_access($user, "view content")) {
    $result = db_query("SELECT nid FROM node WHERE type = 'forum' ORDER BY title");

    $output .= "<TABLE BORDER=\"0\" CELLSPACING=\"4\" CELLPADDING=\"4\">\n";
    $output .= " <TR><TH>". t("Forum") ."</TH><TH>". t("Comments") ."</TH><TH>". t("Last comment") ."</TH><TH>". t("Moderators") ."</TH></TR>";
    while ($node = db_fetch_object($result)) {
      $node = node_get_object(array("nid" => $node->nid));
      $output .= " <TR><TD><A HREF=\"node.php?id=$node->nid\">". check_output($node->title) ."</A><BR><SMALL>". check_output($node->body, 1) ."</SMALL></TD><TD ALIGN=\"center\">". forum_num_comments($node->nid) ."</TD><TD ALIGN=\"center\">". forum_last_comment($node->nid) ."</TD><TD ALIGN=\"center\"><SMALL>". check_output($node->moderate) ."</SMALL></TD></TR>";
    }
    $output .= "</TABLE>\n";

    $theme->header();
    $theme->box(t("Discussion forum"), $output);
    $theme->footer();
  }
  else {
    $theme->header();
    $theme->box(t("Access denied"), message_access());
    $theme->footer();
  }
}

?>