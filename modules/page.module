<?php
// $Id$

/**
 * Implementation of hook_help().
 */
function page_help($section) {
  switch ($section) {
    case 'admin/help#page':
      return t("
      <p>The page module is used when you want to create content that optionally inserts a link into your navigation system. You can also, however, create pages that that don't have this link by skipping the link text field in the page form. At this time, not all themes support the link insertion behavior. Some themes, like xtemplate, provide alternative mechanisms for link creation. Pages are also unique in that they shortcut the typical lifecycle of user generated content (i.e. submit -&gt; moderate -&gt; post -&gt; comment). </p>
      <p>If you enable the <strong>create PHP content</strong> permission for a role, pages may consist of PHP code in addition to HTML and text.</p>
      <h3>User access permissions for pages</h3>
      <p><strong>create pages:</strong> Allows a role to create pages. They cannot edit or delete pages, even if they are the authors. You must enable this permission to in order for a role to create a page.</p>
      <p><strong>edit own pages:</strong> Allows a role to add/edit pages if they own the page. Use this permission if you want users to be able to edit and maintain their own pages.</p>
      ");
    case 'admin/modules#description':
      return t('Enables the creation of pages that can be added to the navigation system.');
    case 'node/add#page':
      return t('If you just want to add a page with a link in the menu to your site, this is the best choice.  Unlike a story, a static page bypasses the submission queue.');
  }
}

/**
 * Implementation of hook_perm().
 */
function page_perm() {
  return array('create pages', 'edit own pages');
}

/**
 * Implementation of hook_node_name().
 */
function page_node_name($node) {
  return t('page');
}

/**
 * Implementation of hook_access().
 */
function page_access($op, $node) {
  global $user;

  if ($op == 'view') {
    return $node->status;
  }

  if ($op == 'create') {
    return user_access('create pages');
  }

  if ($op == 'update') {
    return user_access('edit own pages') && ($user->uid == $node->uid);
  }

  if ($op == 'delete') {
    return user_access('edit own pages') && ($user->uid == $node->uid);
  }
}

/**
 * Implementation of hook_insert().
 */
function page_insert($node) {
  db_query("INSERT INTO {page} (nid, format, link, description) VALUES (%d, %d, '%s', '%s')", $node->nid, $node->format, $node->link, $node->description);
}

/**
 * Implementation of hook_update().
 */
function page_update($node) {
  db_query("UPDATE {page} SET format = %d, link = '%s', description = '%s' WHERE nid = %d", $node->format, $node->link, $node->description, $node->nid);
}

/**
 * Implementation of hook_delete().
 */
function page_delete(&$node) {
  db_query('DELETE FROM {page} WHERE nid = %d', $node->nid);
}

/**
 * Implementation of hook_load().
 */
function page_load($node) {
  return db_fetch_object(db_query('SELECT format, link, description FROM {page} WHERE nid = %d', $node->nid));
}

/**
 * Implementation of hook_menu().
 */
function page_menu() {
  $items = array();
  $items[] = array('path' => 'node/add/page', 'title' => t('page'),
    'access' => page_access('create', NULL));
  return $items;
}

/**
 * Implementation of hook_content().
 *
 * If body is dynamic (using PHP code), the body will be generated.
 */
function page_content($node, $teaser = FALSE) {
  if ($node->format == 1) {
    // PHP type
    ob_start();
    eval($node->body);
    $node->teaser = $node->body = ob_get_contents();
    ob_end_clean();
  }
  else {
    // Assume HTML type by default
    $node = node_prepare($node, $teaser);
  }
  return $node;
}

/**
 * Implementation of hook_view().
 */
function page_view($node, $teaser = FALSE, $page = FALSE) {
  // prepare the node content
  $node = page_content($node, $teaser);
  // print the node
  return theme('node', $node, $teaser, $page);
}

/**
 * Implementation of hook_form().
 */
function page_form(&$node) {
  if (function_exists('taxonomy_node_form')) {
    $output .= implode('', taxonomy_node_form('page', $node));
  }

  if (($node->format == 1) && (!user_access('create php content'))) {
    drupal_set_message(t('the body contents of this page are written in PHP and you do not have sufficient permissions to make changes to the body. You can edit the other elements of the page.'));
    $output .= form_hidden('format', $node->format);
    $hide_types = true;
  }
  else {
    $output .= form_textarea(t('Body'), 'body', $node->body, 60, 20, filter_tips_short(), NULL, TRUE);
  }

  $output .= form_textfield(t('Link name'), 'link', $node->link, 60, 64, t('To make the page show up in the navigation links, enter the name of the link. Otherwise, leave this blank.'));
  $output .= form_textfield(t('Link description'), 'description', $node->description, 60, 64, t("The description displayed when hovering over the page's link.  Leave blank when you don't want a description."));
  $content_type = (user_access('create php content')) ? array(0 => 'HTML', 1 => 'PHP') : false;
  if (!$hide_types && $content_type) {
    $output .= form_radios(t('Type'), 'format', $node->format, $content_type);
  }

  return $output;
}

/**
 * Implementation of hook_validate().
 */
function page_validate(&$node) {
  if ($node->format && user_access('create php content')) {
    // Do not filter PHP code, do not auto-extract a teaser
    $node->teaser = $node->body;
  }

  if (($node->format == 1) && (!user_access('create php content'))) {
    /* Overwrite the submitted node body since they don't have sufficient privileges. */
    $node->body = db_result(db_query('SELECT body FROM {node} WHERE nid = %d', $node->nid));
  }
}

?>
