<?php

$module = array("type" => "page_type",
                "admin" => "page_admin");

$format = array(0 => HTML, 1 => PHP, 2 => text);

function page_type() {
  return array("page", "static page");
}

function page_view($node, $main = 0) {
  global $format, $theme;

  switch ($format[$node->format]) {
    case "PHP":
      $output = eval($node->body);
      break;
    case "text":
      $output = nl2br(htmlentities($node->body));
      break;
    default:
      $output = check_output($node->body, 1);
  }

  $theme->box(check_output($node->title), $output);
}

function page_status() {
  return array(dumped, posted);
}

function page_form($edit = array()) {
  global $format;

  $output .= "<FORM ACTION=\"admin.php?mod=page\" METHOD=\"post\">\n";

  $output .= "<B>Subject:</B><BR>\n";
  $output .= "<INPUT NAME=\"edit[title]\" SIZE=\"55\" VALUE=\"". check_textfield($edit[title]) ."\"><P>\n";

  $output .= structure_form("page", $edit);

  $output .= "<B>Body:</B><BR>\n";
  $output .= "<TEXTAREA NAME=\"edit[body]\" COLS=\"55\" ROWS=\"10\" WRAP=\"virtual\">". check_textarea($edit[body]) ."</TEXTAREA><P>\n";

  $output .= "<B>Type:</B><BR>\n";
  foreach ($format as $key=>$value) $options .= "<OPTION VALUE=\"$key\"". ($edit[format] == $key ? " SELECTED" : "") .">$value</OPTION>\n";
  $output .= "<SELECT NAME=\"edit[format]\">$options</SELECT><P>\n";

  $output .= "<INPUT TYPE=\"hidden\" NAME=\"edit[nid]\" VALUE=\"$edit[nid]\">\n";

  $output .= "<INPUT TYPE=\"submit\" NAME=\"op\" VALUE=\"Save page\">\n";
  $output .= "</FORM>\n";

  return $output;
}

function page_save($edit) {
  global $status;
  node_save(array_merge($edit, array(type => "page", status => $status[posted])));
}

function page_query($type = "") {
  global $status;
  $queries =  array(array("recent pages", "WHERE n.type = 'page' ORDER BY n.timestamp DESC"), array("posted pages", "WHERE n.type = 'page' AND n.status = '$status[posted]' ORDER BY n.timestamp DESC"), array("dumped pages", "WHERE n.type = 'page' AND n.status = '$status[dumped]' ORDER BY n.timestamp DESC"));
  return ($queries[$type] ? $queries[$type] : $queries);
}

function page_overview($query = array()) {
  return node_overview($query);
}

function page_admin() {
  global $id, $op, $edit, $type;

  print "<SMALL><A HREF=\"admin.php?mod=page&op=add\">add new page</A> | <A HREF=\"admin.php?mod=page&op=listing\">page listing</A> | <A HREF=\"admin.php?mod=page\">overview</A></SMALL><HR>\n";

  $type = ($type ? $type : 0);

  switch ($op) {
    case "add":
      print page_form();
      break;
    case "edit":
      print page_form(node_get_array(nid, $id));
      break;
    case "listing":
      print node_listing(page_query());
      break;
   case "Save page":
      print status(page_save($edit));
      // fall through:
    default:
      print page_overview(page_query($type));
  }
}

?>