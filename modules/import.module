<?php
// $Id$


function import_help() {
  $output .= "<p>Thousands of web sites, especially news sites and weblogs, syndicate their most recent site content for others to display. The syndicated content always includes titles, also known as headlines, for the newest published stories.  Each headline acts as a direct link to the stories on the remote site. Along with the headline, most sites typically provide either the first few paragraphs of the story or a short summary. Many individuals use client-based news aggregators on their personal computer to aggregate content, such as <a href=\"http://www.disobey.com/amphetadesk/\">AmphetaDesk</a>.</p>";

  $output .= "<p>Drupal also has a news aggregator built in as a standard feature. With it, you can subscribe to feeds from other sites and display their content for your site users. Simply enable the import module in site administration and enter the feeds that you choose.</p>";
  $output .= "<h3>What do I need to subscribe to a feed?</h3>";
  $output .= "<p>The standard method of syndication is using the XML-based <a href=\"http://groups.yahoo.com/group/rss-dev/files/specification.html\">Rich Site Summary</a> (RSS). To syndicate a site's content, obtain the full URL of the RSS page providing syndication. Common file tags for RSS pages are .rss, .xml and .rdf. Example: <a href=\"http://slashdot.org/slashdot.rdf\">http://slashdot.org/slashdot.rdf</a>.</p>";
  $output .= "<p>Most weblog sites that offer syndication will have an obvious link on the main page. Often you need only look for an xml syndication button, such as the one Drupal uses for site syndication.</p>";
  $output .= "<p>But some sites do not make their RSS feeds as easy to find. Or maybe you want to find a number of feeds on a given topic, without extensively searching the web. In that case, try an RSS syndication directory such as <a href=\"http://www.syndic8.com/\">Syndic8</a>.</p>";
  $output .= "<p>To learn much more about RSS, read Mark Pilgrim's <a href=\"http://www.xml.com/pub/a/2002/12/18/dive-into-xml.html\">What is RSS</a> and WebReference.com's <a href=\"http://www.webreference.com/authoring/languages/xml/rss/1/\">The Evolution of RSS</a>.</p>";
  $output .= "<p>NOTE: Enable your site's xml syndication button by turning on the Syndicate block in block management.</p>";
  $output .= "<h3>Configuring news feeds</h3>";
  $output .= "<p>To subscribe to an RSS feed on another site, use the <i>administer news feeds</i> shortcut at the top of the news aggregation page. The link leads directly to the news aggregation configuration section of Drupal site administration.</p>";
  $output .= "<p>Once there, select <i>add new feed</i> from the left hand menu. Drupal will then ask for the following:</p>";
  $output .= "<ul>";
  $output .= " <li><b>Title</b> -- The text entered here will be used in your news aggregator, within the administration configuration section, and as title for the news feed block. As a general rule, use the web site name from which the feed originates.</li>";
  $output .= " <li><b>URL</b> -- Here you'll enter the fully-qualified URL for the feed for the site you want to subscribe to.</li>";
  $output .= " <li><b>Attributes</b> -- Attributes are keywords which can be used to collect feeds into <i>bundles</i> (see below). Think of these as the means of classifying your feeds. Separate multiple attributes with commas. If you do not plan on using the specific feed in a bundle, this input field can be left blank.</li>";
  $output .= " <li><b>Update interval</b> -- The update interval is how often Drupal will automatically access the RSS URL for the site for fresh content. The 1 hour default is typically the minimum you will want to use. Accessing another site's RSS page more frequently can be considered impolite. After all, it does require the other site's server to handle your automatic requests. To take advantage of this feature, note that cron.php must be configured to have your feeds updated regularly. Otherwise, you'll have to manually update feeds one at a time within the news aggregation administration section by using <i>update items</i>.</li>";
  $output .= "</ul>";
  $output .= "<p>Once you submit your new feed, check to see if it is working properly. Select <i>update items </i> on the main news aggregation page. If you do not see any items listed for that feed, edit the feed and make sure that the URL was entered correctly.</p>";
  $output .= "<h3>Adding bundles</h3>";
  $output .= "<p>You may want to follow some feeds more closely than others. Or perhaps you'd like to display a select list of the titles for some feeds as a block for users.  Bundles are a way of grouping your feeds into categories. Bundles look for feeds that contain at least one of the keywords, or attributes, associated with the bundle and display those feeds together.</p>";
  $output .= "<p>When adding a bundle, Drupal will ask for:</p>";
  $output .= "<ul>";
  $output .= " <li><b>Title</b> -- The title will be used in the <i>news by topics</i> listing in your news aggregator and with the customized block created for the bundle.</li>";
  $output .= " <li><b>Attributes</b> -- Enter one or more of the attributes used to categorize the news feeds already created. Separate multiple attributes with commas.  Be careful to use the same spelling. Don't have any feeds with attributes for the bundle? After creating the bundle, edit existing feeds or create new ones and tag them with the attribute.</li>";
  $output .= "</ul>";
  $output .= "<h3>Using the news aggregator</h3>";
  $output .= "<p>The news aggregator has a number of ways that it displays your subscribed content:</p>";
  $output .= "<ul>";
  $output .= " <li><b>Latest news</b> -- Displays all incoming content in the order received with:";
  $output .= "  <ul>";
  $output .= "   <li>The title of the original post.</li>";
  $output .= "   <li>The name of the source, which acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
  $output .= "   <li>A description, the first few paragraphs or summary of the originating post (if any).</li>";
  $output .= "   <li>A <i>blog it</i> link. Users can select this link to have Drupal automatically prepare a blog post for the specific item.</li>";
  $output .= "   <li>A <i>feed</i> link, which acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
  $output .= "  </ul>";
  $output .= " </li>";
  $output .= " <li><b>News by source -- </b>Organizes incoming content by feed, displaying titles which link to the originating post. Also has an icon which acts as blog it link.</li>";
  $output .= " <li><b>News by topic</b> -- Organizes incoming content by bundles, displaying titles which link to the originating post. Also has an icon which acts as
    blog it link.</li>";
 $output .= " <li><b>News sources</b> -- Displays an alphabetical listing of all subscribed feeds and a description. The title acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
  $output .= "</ul>";
  $output .= "<h3>RSS feed blocks</h3>";
  $output .= "<p>In addition to providing subscribed content through the news aggregator, Drupal automatically creates a block for each subscribed feed and every bundle created.  Beside each headline in each block, Drupal includes an icon which acts a blog it link. Enable any or all of the blocks using block management.</p>";
  return $output;
}

function import_system($field){
  $system["description"] = t("Used to aggregate syndicated content (RSS and RDF).");
  $system["admin_help"] = t("Drupal's news aggregator controls how many RSS/RDF items from a single source are displayed in a \"Block\", and on the page that goes with that block.");
  return $system[$field];
}

function import_settings() {
  $number = array(5 => 5, 10 => 10, 15 => 15, 20 => 20, 25 => 25, 30 => 30, 35 => 35, 40 => 40, 45 => 45, 50 => 50, 55 => 55, 60 => 60, 65 => 65, 70 => 70, 75 => 75, 80 => 80, 85 => 85, 90 => 90, 95 => 95, 100 => 100);
  $output .= form_select("Items per block", "import_block_limit", variable_get("import_block_limit", 15), $number, "The maximum number of news items displayed in one block.");
  $output .= form_select("Items per page", "import_page_limit", variable_get("import_page_limit", 75), $number, "The maximum number of news items displayed on one page.");

  return $output;
}

function import_perm() {
  return array("administer news feeds", "access news feeds");
}

function import_link($type) {

  $links = array();

  if ($type == "page" && user_access("access news feeds")) {
    $links[] = l(t("news feeds"), "import", array("title" => t("Read the latest news from syndicated web sites.")));
  }

  if ($type == "admin" && user_access("administer news feeds")) {
    $help["general"] = t("Several web sites, especially news related sites, syndicate parts of their site's content for other web sites to display. Usually, the syndicated content includes the latest headlines with a direct link to that story on the remote site. Some syndicated content also includes a description of the headline. The standard method of syndication is using the XML based Rich Site Summary (RSS). To get a feed to work you <b>must</b> run \"cron.php\". To display the feed in a block you must turn on the <a href=\"%block\">feed's block</a>. <br /><ul><li>To delete a feed choose \"edit feed\"</li><li>To clear all of the entries from a feed choose \"Remove items\"</li><li>To check whether a feed is working, and to get new items <b>now</b> click on \"update items\"</li></ul><ul><li>To delete a bundle choose \"edit bundle\".</li></ul>", array("%block" => url("admin/block")));
    $help["addfeed"] = t("Add a site to that has an RSS/RDF feed. The URL is the full path to the RSS feed file. For the feed to update you must run \"cron.php\". The \"Attributes\" are used to bundle this feed with other feeds (See <a href=\"%bundle\">add new bundle</a>, and to tag articles from this feed.<br />Note: If you already have another feed with the URL you are planning to use, the system will not accept your entry.", array("%bundle" => url("admin/syndication/news/add/bundle")));
    $help["bundles"] = t("Bundles provide a generalized way of creating composite feeds. They allow you, for example, to combine various sport-related feeds into one bundle called <i>Sport</i>. If an article from a feed has been \"tag\"-ged (See <a href=\"%tag\">tag news item</a> too look at and change tags.) with a matching \"Attribute\" then it will be added to the bundle.", array("%tag" => url("admin/syndication/news/tag")));
    $help["tag"] = t("This allows you to see and change an news item's \"tag\". All articles are originally tagged with the \"Attributes\" of their feed.");

    menu("admin/syndication", "content syndication", NULL, NULL, 5);
    menu("admin/syndication/news", "news aggregation", "import_admin", $help["general"]);
    menu("admin/syndication/news/add/feed", "add new feed", "import_admin", $help["addfeed"], 2);
    menu("admin/syndication/news/add/bundle", "add new bundle", "import_admin", $help["bundles"], 3);
    menu("admin/syndication/news/tag", "tag news items", "import_admin", $help["tag"], 4);
    menu("admin/syndication/news/help", "help", "import_help", NULL, 9);
  }

  return $links;
}

function import_cron() {
  $result = db_query("SELECT * FROM feed WHERE timestamp + refresh < ". time());
  while ($feed = db_fetch_array($result)) {
    import_refresh($feed);
  }
}

function import_update() {
  $result = db_query("SELECT * FROM feed");
  while ($feed = db_fetch_array($result)) {
    import_refresh($feed);
  }
}

function import_format_item($item, $feed = 0) {
  global $user;

  if ($user->uid && module_exist("blog") && user_access("maintain personal blog")) {
    $output .= "<div class=\"icon\">". l("<img src=\"". theme("image", "blog.gif") ."\" alt=\"". t("blog it") ."\" title=\"". t("blog it") ."\" />", "node/add/blog&amp;iid=$item->iid", array("title" => t("Comment on this news item in your personal blog."), "class" => "blog-it")) ."</div>";
  }

  // external link
  $output .= "<a href=\"$item->link\">$item->title</a>";

  return $output;
}

function import_bundle_block($attributes) {

  if ($attributes) {
    $keys = explode(",", $attributes);
    foreach ($keys as $key) $where[] = "attributes LIKE '%". trim($key) ."%'";

    $result = db_query_range("SELECT * FROM item WHERE ". implode(" OR ", $where) ." ORDER BY iid DESC", 0, variable_get("import_block_limit", 15));
  }

  $items = array();
  while ($item = db_fetch_object($result)) {
    $items[] = import_format_item($item);
  }

  $output = "<div class=\"import-block\"><div class=\"bundle\">";
  $output .= theme("theme_item_list", $items);
  $output .= "</div></div>";

  return $output;
}

function import_feed_block($feed) {
  $result = db_query_range("SELECT * FROM item WHERE fid = %d ORDER BY iid DESC ", $feed->fid, 0, variable_get("import_block_limit", 15));

  $items = array();
  while ($item = db_fetch_object($result)) {
    $items[] = import_format_item($item);
  }

  $output = "<div class=\"import-block\"><div class=\"feed\">";
  $output .= theme("theme_item_list", $items);
  $output .= "</div></div>";

  return $output;
}

function import_block($op, $delta) {
  if ($op == "list") {
    $result = db_query("SELECT * FROM bundle ORDER BY title");
    while ($bundle = db_fetch_object($result)) {
      $block["bundle:$bundle->bid"]["info"] = "$bundle->title bundle";
    }

    $result = db_query("SELECT * FROM feed ORDER BY fid");
    while ($feed = db_fetch_object($result)) {
      $block["feed:$feed->fid"]["info"] = "$feed->title feed";
    }

    return $block;
  }
  else {
    list($type, $id) = split(":", $delta);
    switch ($type) {
      case "feed":
        $feed = db_fetch_object(db_query("SELECT * FROM feed WHERE fid = %d", $id));
        $block["subject"] = $feed->title;
        $block["content"] .= import_feed_block($feed) ."<div style=\"text-align: right;\">".  l(t("more"), "import/feed/$feed->fid", array("title" => t("View this feed's recent news."))) ."</div>";
        break;

      case "bundle":
        $bundle = db_fetch_object(db_query("SELECT * FROM bundle WHERE bid = %d", $id));
        $block["subject"] = $bundle->title;
        $block["content"] .= import_bundle_block($bundle->attributes) ."<div style=\"text-align: right;\">". l(t("more"), "import/bundle/$bundle->bid", array("title" => t("View this bundle's recent news."))) ."</div>";
        break;
    }

    return $block;
  }
}

function import_get_bundles($attributes = 0) {

  $block = array();

  $result = db_query("SELECT * FROM bundle ORDER BY title");
  while ($bundle = db_fetch_object($result)) {
    $block["bundle:$bundle->bid"]["subject"] = $bundle->title;
    $block["bundle:$bundle->bid"]["content"] = import_bundle_block($bundle->attributes) ."<div style=\"text-align: right;\">".
                                                l(t("more"), "import/bundle/$bundle->bid", array("title" => t("View this bundle's recent news.")))
                                                ."</div>";
    $block["bundle:$bundle->bid"]["info"] = "$bundle->title bundle";
  }

  return $block;
}

function import_get_feeds($attributes = 0) {

  $block = array();

  $result = db_query("SELECT * FROM feed ORDER BY fid");
  while ($feed = db_fetch_object($result)) {
    $block["feed:$feed->fid"]["subject"] = $feed->title;
    $block["feed:$feed->fid"]["content"] = import_feed_block($feed) ."<div style=\"text-align: right;\">".
                                            l(t("more"), "import/feed/$feed->fid", array("title" => t("View this feed's recent news.")))
                                            ."</div>";
    $block["feed:$feed->fid"]["info"] = "$feed->title feed";
  }

  return $block;
}

function import_remove($feed) {
  db_query("DELETE FROM item WHERE fid = %d", $feed["fid"]);
  return t("removed news items from '%site'.", array("%site" => $feed["title"]));
}

// Call-back function used by XML parser:
function import_element_start($parser, $name, $attributes) {
  global $item, $element, $tag;

  switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
      $element = $name;
      break;
    case "ITEM":
      $element = $name;
      $item += 1;
  }

  $tag = $name;
}

// Call-back function used by XML parser:
function import_element_end($parser, $name) {
  global $element;

   switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
    case "ITEM":
      $element = "";
  }
}

// Call-back function used by XML parser:
function import_element_data($parser, $data) {
  global $channel, $element, $items, $item, $tag;

  switch ($element) {
    case "ITEM":
      $items[$item][$tag] .= $data;
      break;
    case "IMAGE":
    case "TEXTINPUT":
      /*
      ** The sub-elements "image" and "textinput" are not supported
      ** but we have recognize them or their content will end up in
      ** the items-array.
      */
      break;
    default:
      $channel[$tag] .= $data;
  }
}

function import_refresh($feed) {

  // unset the global variables before we use them:
  unset($GLOBALS["channel"], $GLOBALS["element"], $GLOBALS["item"], $GLOBALS["items"], $GLOBALS["tag"]);

  // after we unset the variables, we can global them again:
  global $items, $channel;

  /*
  ** Check whether the feed is properly configured:
  */

  if (!ereg("^http://|ftp://", $feed["url"])) {
    return t("failed to parse RSS feed '%site': incorrect or missing URL.", array("%side" => $feed["title"]));
  }

  /*
  ** Grab the news items:
  */

  if ($fp = @fopen($feed["url"], "r")) {
    // fetch data:
    while (!feof($fp)) {
      $data .= fgets($fp, 128);
    }
    fclose($fp);

    // filter the input data:
    xss_check_input_data($data);

    // parse the data:
    $xml_parser = xml_parser_create();
    xml_set_element_handler($xml_parser, "import_element_start", "import_element_end");
    xml_set_character_data_handler($xml_parser, "import_element_data");
    xml_parser_set_option($xml_parser, XML_OPTION_TARGET_ENCODING, "utf-8");

    if (!xml_parse($xml_parser, $data, 1)) {
      return t("failed to parse RSS feed '%site': %error at line %line.", array("%site" => $feed["title"], "%error" => xml_error_string(xml_get_error_code($xml_parser)), "%line" => xml_get_current_line_number($xml_parser)));
    }
    xml_parser_free($xml_parser);

    // initialize the translation table:
    $tt = array_flip(get_html_translation_table(HTML_ENTITIES));
    $tt["&apos;"] = "'";

    db_query("UPDATE feed SET timestamp = %d, link = '%s', description = '%s' WHERE fid = %d", time(), $channel["LINK"], $channel["DESCRIPTION"], $feed["fid"]);

    /*
    ** We reverse the array such that we store the first item last,
    ** and the last item first.  In the database, the newest item
    ** should be at the top.
    */

    $items = array_reverse($items);

    foreach ($items as $item) {
      unset($title, $link, $author, $description);

      // Prepare the item:
      foreach ($item as $key => $value) {
        $item[$key] = node_filter(strtr(trim($value), $tt));
      }

      if ($item["TITLE"]) {
        $title = $item["TITLE"];
      }
      else {
        /*
         ** Use up to 40 characters of the description, ending at
         ** word boundary, but don't split potential entities.
         */
        $title = preg_replace('/^(.*)[^\w;&].*?$/', "\\1", substr($item["DESCRIPTION"], 0, 40));
      }

      if ($item["LINK"]) {
        $link = $item["LINK"];
      }
      elseif ($item["GUID"] && (strncmp($item["GUID"], "http://", 7) == 0)) {
        $link = $item["GUID"];
      }
      else {
        $link = $feed["link"];
      }

      /*
      ** Save this item.  Try to avoid duplicate entries as much as
      ** possible.  If we find a duplicate entry, we resolve it and
      ** pass along it's ID such that we can update it if needed.
      */

      if ($link && $link != $feed["link"] && $link != $feed["url"]) {
        $entry = db_fetch_object(db_query("SELECT iid FROM item WHERE fid = %d AND link = '%s'", $feed["fid"], $link));
      }
      else {
        $entry = db_fetch_object(db_query("SELECT iid FROM item WHERE fid = %d AND title = '%s'", $feed["fid"], $title));
      }

      import_save_item(array(iid => $entry->iid, fid => $feed["fid"], title => $title, link => $link, author => $item["AUTHOR"], description => $item["DESCRIPTION"], attributes => $feed["attributes"]));
    }

    /*
    ** Remove all the old, expired items:
    */

    unset($items);

    $result = db_query("SELECT iid FROM item WHERE fid = %d ORDER BY timestamp", $feed["fid"]);

    while ($item = db_fetch_object($result)) {
      $items[] = "iid = '$item->iid'";
    }

    if (sizeof($items) > 50) {
      db_query("DELETE FROM item WHERE ". implode(" OR ", array_slice($items, 0, - 50)));
    }

    cache_clear_all();
  }
  else {
    return t("failed to parse RSS feed '%site': no data.", array("%site" => $feed["tite"]));
  }

  return t("syndicated content from '%site'.", array("%site" => $feed["title"]));
}

function import_save_item($edit) {
  if ($edit["iid"] && $edit["title"]) {
    db_query("UPDATE item SET title = '%s', link = '%s', author = '%s', description = '%s', attributes = '%s' WHERE iid = %d", $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], $edit["iid"]);
  }
  else if ($edit["iid"]) {
    db_query("DELETE FROM item WHERE iid = %d", $edit["iid"]);
  }
  else if ($edit["title"] && $edit["link"]) {
    db_query("INSERT INTO item (fid, title, link, author, description, attributes, timestamp) VALUES (%d, '%s', '%s', '%s', '%s', '%s', %d)", $edit["fid"], $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], time());
  }
}

function import_form_bundle($edit = array()) {

  $form .= form_textfield("Title", "title", $edit["title"], 50, 64, "The name of the bundle.");
  $form .= form_textfield("Attributes", "attributes", $edit["attributes"], 50, 128, "A comma-separated list of keywords describing the bundle.");

  $form .= form_submit("Submit");

  if ($edit["bid"]) {
    $form .= form_submit("Delete");
    $form .= form_hidden("bid", $edit["bid"]);
  }

  return form($form);
}

function import_save_bundle($edit) {
  if ($edit["bid"] && $edit["title"]) {
    db_query("UPDATE bundle SET title = '%s', attributes = '%s' WHERE bid = %d", $edit["title"], $edit["attributes"], $edit["bid"]);
  }
  else if ($edit["bid"]) {
    db_query("DELETE FROM bundle WHERE bid = %d", $edit["bid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("bundle_bid");
    db_query("INSERT INTO bundle (bid, title, attributes) VALUES (%d, '%s', '%s')", $next_id, $edit["title"], $edit["attributes"]);
  }
}

function import_form_feed($edit = array()) {

  $period = array(900 => format_interval(900), 1800 => format_interval(1800), 3600 => format_interval(3600), 7200 => format_interval(7200), 10800 => format_interval(10800), 21600 => format_interval(21600), 32400 => format_interval(32400), 43200 => format_interval(43200), 64800 => format_interval(64800), 86400 => format_interval(86400), 172800 => format_interval(172800), 259200 => format_interval(259200), 604800 => format_interval(604800), 1209600 => format_interval(1209600), 2419200 => format_interval(2419200));

  if ($edit["refresh"] == "") {
    $edit["refresh"] = 3600;
  }

  $form .= form_textfield("Title", "title", $edit["title"], 50, 64, "The name of the feed; typically the name of the web site you syndicate content from.");
  $form .= form_textfield("Url", "url", $edit["url"], 50, 128, "The fully-qualified URL of the feed.");
  $form .= form_textfield("Attributes", "attributes", $edit["attributes"], 50, 128, "A comma-separated list of keywords describing the feed.");
  $form .= form_select("Update interval", "refresh", $edit["refresh"], $period, "The refresh interval indicating how often you want to update this feed.  Requires crontab.");

  $form .= form_submit("Submit");

  if ($edit["fid"]) {
    $form .= form_submit("Delete");
    $form .= form_hidden("fid", $edit["fid"]);
  }

  return form($form);
}

function import_save_feed($edit) {
  if ($edit["fid"] && $edit["title"]) {
    db_query("UPDATE feed SET title = '%s', url = '%s', attributes = '%s', refresh = %d WHERE fid = %d", $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"], $edit["fid"]);
    db_query("DELETE FROM item WHERE fid = %d", $edit["fid"]);
  }
  else if ($edit["fid"]) {
    db_query("DELETE FROM feed WHERE fid = %d", $edit["fid"]);
    db_query("DELETE FROM item WHERE fid = %d", $edit["fid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("feed_fid");
    db_query("INSERT INTO feed (fid, title, url, attributes, refresh) VALUES (%d, '%s', '%s', '%s', %d)", $next_id, $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"]);
  }
}

function import_save_attributes($edit) {
  foreach ($edit as $iid => $value) {
    db_query("UPDATE item SET attributes = '%s' WHERE iid = %d", $value, $iid);
  }
  return "attributes has been saved";
}

function import_get_feed($fid) {
  return db_fetch_array(db_query("SELECT * FROM feed WHERE fid = %d", $fid));
}

function import_get_bundle($bid) {
  return db_fetch_array(db_query("SELECT * FROM bundle WHERE bid = %d", $bid));
}

function import_view() {
  $result = db_query("SELECT f.*, COUNT(i.iid) AS items FROM feed f LEFT JOIN item i ON f.fid = i.fid GROUP BY f.fid, f.title, f.url, f.refresh, f.timestamp, f.attributes, f.link, f.description ORDER BY f.title");

  $output .= "<h3>Feed overview</h3>";

  $header = array(t("title"), t("attributes"), t("items"), t("last update"), t("next update"), array("data" => t("operations"), "colspan" => 3));
  unset($rows);
  while ($feed = db_fetch_object($result)) {
    $rows[] = array($feed->title, $feed->attributes, format_plural($feed->items, "1 item", "%count items"), ($feed->timestamp ? format_interval(time() - $feed->timestamp) ." ago" : "never"), ($feed->timestamp ? format_interval($feed->timestamp + $feed->refresh - time()) ." left" : "never"), l(t("edit feed"), "admin/syndication/news/edit/feed/$feed->fid"), l(t("remove items"), "admin/syndication/news/remove/$feed->fid"), l(t("update items"), "admin/syndication/news/update/$feed->fid"));
  }
  $output .= table($header, $rows);

  $result = db_query("SELECT * FROM bundle ORDER BY title");

  $output .= "<h3>Bundle overview</h3>";

  $header = array(t("title"), t("attributes"), t("operations"));
  unset($rows);
  while ($bundle = db_fetch_object($result)) {
    $rows[] = array($bundle->title, $bundle->attributes, l(t("edit bundle"), "admin/syndication/news/edit/bundle/$bundle->bid"));
  }
  $output .= table($header, $rows);

  return $output;
}

function import_tag() {

  $result = db_query_range("SELECT i.*, f.title AS feed FROM item i LEFT JOIN feed f ON i.fid = f.fid ORDER BY i.iid DESC", 0, 50);

  $header = array(t("date"), t("feed"), t("news item"));
  while ($item = db_fetch_object($result)) {
    $rows[] = array(array("data" => format_date($item->timestamp, "small"), "nowrap" => "nowrap", "valign" => "top"), array("data" => l($item->feed, "admin/syndication/news/edit/feed/$item->fid"), "valign" => "top"), "<a href=\"$item->link\">$item->title</a>". ($item->description ? "<br /><small><i>$item->description</i></small>" : "") ."<br /><input type=\"text\" name=\"edit[$item->iid]\" value=\"". check_form($item->attributes) ."\" size=\"50\" />");
  }

  $output .= table($header, $rows);
  $output .= "<input type=\"submit\" name=\"op\" value=\"Save attributes\" />\n";

  return form($output);
}

function import_admin() {
  $op = $_POST["op"];
  $edit = $_POST["edit"];

  if (user_access("administer news feeds")) {

    if (empty($op)) {
      $op = arg(3);
    }

    switch ($op) {
      case "add":
        if (arg(4) == "bundle") {
          print import_form_bundle();
        }
        else {
          print import_form_feed();
        }
        break;
      case "edit":
        if (arg(4) == "bundle") {
          print import_form_bundle(import_get_bundle(arg(5)));
        }
        else {
          print import_form_feed(import_get_feed(arg(5)));
        }
        break;
      case "remove":
        print status(import_remove(import_get_feed(arg(4))));
        print import_view();
        break;
      case "update":
        print status(import_refresh(import_get_feed(arg(4))));
        print import_view();
        break;
      case "tag":
        print import_tag();
        break;
      case "Save attributes":
        print status(import_save_attributes($edit));
        print import_tag();
        break;
      case "Delete":
        $edit["title"] = 0;
        // fall through:
      case "Submit":
        if (arg(4) == "bundle") {
          print status(import_save_bundle($edit));
        }
        else {
          print status(import_save_feed($edit));
        }
        // fall through:
      default:
        print import_view();
    }
  }
  else {
    print message_access();
  }
}

function import_page_info() {


  $links[] = l(t("latest news"), "import", array("title" => t("Read the latest news from syndicated web sites.")));
  $links[] = l(t("news by source"), "import/feeds", array("title" => t("View the latest headlines sorted by source.")));
  $links[] = l(t("news by topic"), "import/bundles", array("title" => t("View the latest headlines sorted by topic.")));
  $links[] = l(t("news sources"), "import/sources", array("title" => t("View a list of all the web sites we syndicate from.")));

  if (user_access("administer news feeds")) {
    $links[] = l(t("administer news feeds"), "admin/syndication/news", array("title" => t("View the news feed administrative pages.")));
  }

  return "<div style=\"text-align: center;\">". theme("links", $links) ."</div>";
}

function import_page_last() {


  $result = db_query_range("SELECT i.*, f.title AS ftitle, f.link AS flink FROM item i LEFT JOIN feed f ON i.fid = f.fid ORDER BY i.iid DESC", 0, variable_get("import_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = l(t("feed"), "import/feed/$item->fid", array("title" => t("Read more syndicated news from this feed.")));

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". l($item->ftitle, "import/feed/$item->fid", array("title" => t("View more information about this feed."))) ."</td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  theme("header");
  theme("box", t("News feeds"), import_page_info());
  theme("box", t("Latest news"), $output);
  theme("footer");
}

function import_page_feed($fid) {


  $feed = db_fetch_object(db_query("SELECT * FROM feed WHERE fid = %d", $fid));

  $header .= "<p><b>". t("Website") .":</b><div style=\"margin-left: 20px;\"><a href=\"$feed->link\">$feed->link</a></div></p>";
  $header .= "<p><b>". t("Description") .":</b><div style=\"margin-left: 20px;\">$feed->description</div></p>";
  $header .= "<p><b>". t("Last update") .":</b><div style=\"margin-left: 20px; text-align: right;\">". format_interval(time() - $feed->timestamp) ." ". t("ago") ." <a href=\"$feed->url\"><img src=\"". theme("image", "xml.gif") ."\" width=\"36\" height=\"14\" style=\"border: 0px;\" alt=\"\" title=\"\" /></a><br /><br /></div></p>\n";

  $result = db_query_range("SELECT * FROM item WHERE fid = %d ORDER BY iid DESC", $fid, 0, variable_get("import_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a></td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }
    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  theme("header");
  theme("box", t("News feeds"), import_page_info());
  theme("box", $feed->title, $header);
  theme("box", t("Latest news"), $output);
  theme("footer");
}

function import_page_bundle($bid) {


  $bundle = db_fetch_object(db_query("SELECT * FROM bundle WHERE bid = %d", $bid));

  $header .= "<p><b>". t("Website") .":</b><div style=\"margin-left: 20px;\">". l($bundle->title, "import/bundle/$bundle->bid") ."</div></p>";
  $header .= "<p><b>". t("Description") .":</b><div style=\"margin-left: 20px;\">". t("A composite news feed about") ." $bundle->attributes.</div></p>";

  $keys = explode(",", $bundle->attributes);
  foreach ($keys as $key) $where[] = "i.attributes LIKE '%". trim($key) ."%'";
  $result = db_query_range("SELECT i.*, f.title AS ftitle, f.link AS flink FROM item i, feed f WHERE (". implode(" OR ", $where) .") AND i.fid = f.fid ORDER BY iid DESC", 0, variable_get("import_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = l(t("feed"), "import/feed/$item->fid", array("title" => t("Read more syndicated news from this feed.")));
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". l($item->ftitle, "import/feed/$item->fid", array("title" => t("View more information about this feed."))) ."</td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  theme("header");
  theme("box", t("News feeds"), import_page_info());
  theme("box", $bundle->title, $header);
  theme("box", t("Latest news"), $output);
  theme("footer");

}

function import_page_sources() {


  $result = db_query("SELECT * FROM feed ORDER BY title");

  while ($feed = db_fetch_object($result)) {
    $output .= l($feed->title, "import/feed/$feed->fid");
    $output .= "<div style=\"margin-left: 20px;\">$feed->description</div><br />";
  }

  $output .= "<div style=\"text-align: right\">" . l("<img src=\"". theme("image", "xml.gif") ."\" width=\"36\" height=\"14\" style=\"border: 0px;\" />", "import/fd", array("title" => t("View the list of syndicated web sites in XML format."))) . "</div><br />";

  theme("header");
  theme("box", t("News feeds"), import_page_info());
  theme("box", t("News sources"), $output);
  theme("footer");
}

function import_page_fd() {

  $result = db_query("SELECT * FROM feed ORDER BY title");

  $output .= "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n\n";
  $output .= "<rssfeeds version=\"0.1\">\n\n";

  while ($feed = db_fetch_object($result)) {
    $output .= "<channel>\n";
    $output .= " <title>". drupal_specialchars($feed->title) ."</title>\n";
    $output .= " <link>". drupal_specialchars($feed->url) ."</link>\n";
    $output .= "</channel>\n\n";
  }

  $output .= "</rssfeeds>\n";

  header("Content-Type: text/xml");

  print $output;
}

function import_page_bundles() {
  import_page_blocks(import_get_bundles());
}

function import_page_feeds() {
  import_page_blocks(import_get_feeds());
}

function import_page_blocks($blocks) {


  theme("header");
  theme("box", t("News feeds"), import_page_info());
  print "<table cellpadding=\"0\" cellspacing=\"5\" border=\"0\" style=\"width: 100%;\">\n";
  print " <tr>\n";

  for ($t = 0; $t < 3; $t++) {
    $i = 1;
    print "  <td style=\"vertical-align: top; width: 33%;\">\n";
    while ($block = each($blocks)) {
      theme("box", $block["value"]["subject"], $block["value"]["content"]);
      if ($i == ceil(count($blocks) / 3)) {
        break;
      }
      $i++;
    }
    print "  </td>\n";
  }

  print " </tr>\n";
  print "</table>\n";
  theme("footer");
}

function import_page() {
  if (user_access("access news feeds")) {
    switch (arg(1)) {
      case "feed":
        import_page_feed(arg(2));
        break;
      case "bundle":
        import_page_bundle(arg(2));
        break;
      case "feeds":
        import_page_feeds();
        break;
      case "bundles":
        import_page_bundles();
        break;
      case "sources":
        import_page_sources();
        break;
      case "fd":
        import_page_fd();
        break;
      default:
        import_page_last();
    }
  }
}

?>
