<?php
/* $Id$ */

function aggregator_help($section) {
  switch ($section) {
    case 'admin/help#aggregator':
      $output = "<p>Thousands of web sites, especially news sites and weblogs, syndicate their most recent site content for others to display. The syndicated content always includes titles, also known as headlines, for the newest published stories.  Each headline acts as a direct link to the stories on the remote site. Along with the headline, most sites typically provide either the first few paragraphs of the story or a short summary. Many individuals use client-based news aggregators on their personal computer to aggregate content, such as %amphetadesk</p>";
      $output .= "<p>Drupal also has a news aggregator built in as a standard feature. With it, you can subscribe to feeds from other sites and display their content for your site users. Simply enable the aggregator module in site administration and enter the feeds that you choose.</p>";
      $output .= "<h3>What do I need to subscribe to a feed?</h3>";
      $output .= "<p>The standard method of syndication is using the XML-based %rss (RSS). To syndicate a site's content, obtain the full URL of the RSS page providing syndication. Common file tags for RSS pages are .rss, .xml and .rdf. Example: %slashdot-rss.</p>";
      $output .= "<p>Most weblog sites that offer syndication will have an obvious link on the main page. Often you need only look for an XML syndication button, such as the one Drupal uses for site syndication.</p>";
      $output .= "<p>But some sites do not make their RSS feeds as easy to find. Or maybe you want to find a number of feeds on a given topic, without extensively searching the web. In that case, try an RSS syndication directory such as %syndic8.</p>";
      $output .= "<p>To learn much more about RSS, read Mark Pilgrim's %rss-what and WebReference.com's %rss-evolution.</p>";
      $output .= "<p>NOTE: Enable your site's XML syndication button by turning on the Syndicate block in block management.</p>";
      $output .= "<h3>Configuring news feeds</h3>";
      $output .= "<p>To subscribe to an RSS feed on another site, use the %admin-news shortcut at the top of the news aggregation page. The link leads directly to the news aggregation configuration section of Drupal site administration.</p>";
      $output .= "<p>Once there, select %new-feed from the left hand menu. Drupal will then ask for the following:</p>";
      $output .= "<ul>";
      $output .= "<li><strong>Title</strong> -- The text entered here will be used in your news aggregator, within the administration configuration section, and as title for the news feed block. As a general rule, use the web site name from which the feed originates.</li>";
      $output .= " <li><strong>URL</strong> -- Here you'll enter the fully-qualified URL for the feed for the site you want to subscribe to.</li>";
      $output .= "<li><strong>Attributes</strong> -- Attributes are keywords which can be used to collect feeds into <i>bundles</i> (see below). Think of these as the means of classifying your feeds. Separate multiple attributes with commas. If you do not plan on using the specific feed in a bundle, this input field can be left blank.</li>";
      $output .= "<li><strong>Update interval</strong> -- The update interval is how often Drupal will automatically access the RSS URL for the site for fresh content. The 1 hour default is typically the minimum you will want to use. Accessing another site's RSS page more frequently can be considered impolite. After all, it does require the other site's server handle your requests. To use this feature cron.php must be called regularly, otherwise, you'll have to manually update feeds one at a time within the news aggregation administration section by using %update-items.</li>";
      $output .= "</ul>";
      $output .= "<p>Once you submit your new feed, check to see if it is working properly. Select %update-items on the %admin-news page. If you do not see any items listed for that feed, edit the feed and make sure that the URL was entered correctly.</p>";
      $output .= "<h3>Adding bundles</h3>";
      $output .= "<p>You may want to follow some feeds more closely than others. Or perhaps you'd like to display a select list of the titles for some feeds as a block for users.  Bundles are a way of grouping your feeds into categories. Bundles look for feeds that contain at least one of the keywords, or attributes, associated with the bundle and display those feeds together.</p>";
      $output .= "<p>When adding a bundle, Drupal will ask for:</p>";
      $output .= "<ul>";
      $output .= " <li><strong>Title</strong> -- The title will be used in the <i>news by topics</i> listing in your news aggregator and with the customized block created for the bundle.</li>";
      $output .= " <li><strong>Attributes</strong> -- Enter one or more of the attributes used to categorize the news feeds already created. Separate multiple attributes with commas.  Be careful to use the same spelling. Don't have any feeds with attributes for the bundle? After creating the bundle, edit existing feeds or create new ones and tag them with the attribute.</li>";
      $output .= "</ul>";
      $output .= "<h3>Using the news aggregator</h3>";
      $output .= "<p>The news aggregator has a number of ways that it displays your subscribed content:</p>";
      $output .= "<ul>";
      $output .= " <li><strong>Latest news</strong> -- Displays all incoming content in the order received with:";
      $output .= "  <ul>";
      $output .= "   <li>The title of the original post.</li>";
      $output .= "   <li>The name of the source, which acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
      $output .= "   <li>A description, the first few paragraphs or summary of the originating post (if any).</li>";
      $output .= "   <li>A <i>blog it</i> link. Users can select this link to have Drupal automatically prepare a blog post for the specific item.</li>";
      $output .= "   <li>A <i>feed</i> link, which acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
      $output .= "  </ul>";
      $output .= " </li>";
      $output .= " <li><strong>News by source</strong> -- Organizes incoming content by feed, displaying titles which link to the originating post. Also has an icon which acts as blog it link.</li>";
      $output .= " <li><strong>News by topic</strong> -- Organizes incoming content by bundles, displaying titles which link to the originating post. Also has an icon which acts as blog it link.</li>";
      $output .= " <li><strong>News sources</strong> -- Displays an alphabetical listing of all subscribed feeds and a description. The title acts as a link to an individual feed page, listing information about that feed and incoming content for that feed only.</li>";
      $output .= "</ul>";
      $output .= "<h3>RSS feed blocks</h3>";
      $output .= "<p>In addition to providing subscribed content through the news aggregator, Drupal automatically creates a block for each subscribed feed and every bundle created.  Beside each headline in each block, Drupal includes an icon which acts a blog it link. Enable any or all of the blocks using block management.</p>";
      $output .= "<h3>Subscription list</h3>";
      $output .= "<p>Drupal automatically generates an OPML feed file that is available by selecting the XML icon on the News Sources page.</p>";
      $output .= "<h3>Technical details</h3>";
      $output .= "<p>When fetching feeds Drupal supports conditional GETs, this reduces the bandwidth usage for feeds that have not been updated since the last check.</p>";
      $output .= "<p>If a feed is permanently moved to a new location Drupal will automatically update the feed URL to the new address.</p>";
      return t($output, array("%amphetadesk" => "<a href=\"http://www.disobey.com/amphetadesk/\">AmphetaDesk</a>", "%rss" => "<a href=\"http://groups.yahoo.com/group/rss-dev/files/specification.html\">Rich Site Summary</a>", "%slashdot-rss" => "<a href=\"http://slashdot.org/slashdot.rdf\">http://slashdot.org/slashdot.rdf</a>", "%syndic8" => "<a href=\"http://www.syndic8.com/\">Syndic8</a>", "%rss-what" => "<a href=\"http://www.xml.com/pub/a/2002/12/18/dive-into-xml.html\">What is RSS</a>", "%rss-evolution" => "<a href=\"http://www.webreference.com/authoring/languages/xml/rss/1/\">The Evolution of RSS</a>", "%admin-news" => l(t("RSS/RDF"), "admin/node/syndication/news"), "%new-feed" => l(t("new feed"), "admin/node/syndication/news/add/feed"), "%update-items" => l(t("update items"), "admin/node/syndication/news")));
    case 'admin/system/modules#description':
      return t("Used to aggregate syndicated content (RSS and RDF).");
    case 'admin/system/modules/aggregator':
      return t("Drupal's news aggregator controls how many RSS/RDF items from a single source are displayed in a \"Block\", and on the page that goes with that block.");
    case 'admin/node/syndication/news':
      return t("Several web sites, especially news related sites, syndicate parts of their site's content for other web sites to display. Usually, the syndicated content includes the latest headlines with a direct link to that story on the remote site. Some syndicated content also includes a description of the headline. The standard method of syndication is using the XML based Rich Site Summary (RSS). To get a feed to work you <strong>must</strong> run \"cron.php\". To display the feed in a block you must turn on the %block. <br /><ul><li>To delete a feed choose \"edit feed\"</li><li>To clear all of the entries from a feed choose \"Remove items\"</li><li>To check whether a feed is working, and to get new items <strong>now</strong> click on \"update items\"</li></ul><ul><li>To delete a bundle choose \"edit bundle\".</li></ul>", array("%block" => l(t("feed's block"), "admin/system/block")));
    case 'admin/node/syndication/news/add/feed':
      return t("Add a site that has an RSS/RDF feed. The URL is the full path to the RSS feed file. For the feed to update automatically you must run \"cron.php\". The \"Attributes\" are used to bundle this feed with other feeds (See %bundle), and to tag articles from this feed.<br />Note: If you already have a feed with the URL you are planning to use, the system will not accept another feed with the same URL.", array("%bundle" => l(t("add new bundle"), "admin/node/syndication/news/add/bundle")));
    case 'admin/node/syndication/news/add/bundle':
      return t("Bundles provide a generalized way of creating composite feeds. They allow you, for example, to combine various sport-related feeds into one bundle called <i>Sport</i>. If an article from a feed has been \"tag\"-ged (See %tag too look at and change tags.) with a matching \"Attribute\" then it will be added to the bundle.", array("%tag" => l(t("tag news item"), "admin/node/syndication/news/tag")));
    case 'admin/node/syndication/news/tag':
      return t("This allows you to see and change an news item's \"tag\". All articles are originally tagged with the \"Attributes\" of their feed.");
  }
}

function aggregator_help_page() {
  print theme('page', aggregator_help('admin/help#aggregator'));
}

function aggregator_settings() {
  $number = array(5 => 5, 10 => 10, 15 => 15, 20 => 20, 25 => 25, 30 => 30, 35 => 35, 40 => 40, 45 => 45, 50 => 50, 55 => 55, 60 => 60, 65 => 65, 70 => 70, 75 => 75, 80 => 80, 85 => 85, 90 => 90, 95 => 95, 100 => 100);

  $output = form_select(t('Items per block'), 'aggregator_block_limit', variable_get('aggregator_block_limit', 15), $number, t('The maximum number of news items displayed in one block.'));
  $output .= form_select(t('Items per page'), 'aggregator_page_limit', variable_get('aggregator_page_limit', 75), $number, t('The maximum number of news items displayed on one page.'));

  return $output;
}

function aggregator_perm() {
  return array('administer news feeds', 'access news feeds');
}

function aggregator_link($type) {
  if ($type == 'page' && user_access('access news feeds')) {
    return array(l(t('news feeds'), 'aggregator', array('title' => t('Read the latest news from syndicated web sites.'))));
  }

  if ($type == 'system') {
    if (user_access('administer news feeds')) {
      menu('admin/node/syndication', t('syndication'), NULL, 5);
      menu('admin/node/syndication/news', t('RSS/RDF'), 'aggregator_admin');
      menu('admin/node/syndication/news/add/feed', t('new feed'), 'aggregator_admin', 2);
      menu('admin/node/syndication/news/add/bundle', t('new bundle'), 'aggregator_admin', 3);
      menu('admin/node/syndication/news/tag', t('tag items'), 'aggregator_admin', 4);
      menu('admin/node/syndication/news/help', t('help'), 'aggregator_help_page', 9);
    }

    if (user_access('access news feeds')) {
      menu('aggregator', t('news aggregator'), 'aggregator_page', 5);
      menu('aggregator/feeds', t('news by source'), 'aggregator_page');
      menu('aggregator/bundles', t('news by topic'), 'aggregator_page');
      menu('aggregator/sources', t('news sources'), 'aggregator_page');
    }
  }
}

function aggregator_cron() {
  $result = db_query("SELECT * FROM {feed} WHERE checked + refresh < %d", time());
  while ($feed = db_fetch_array($result)) {
    aggregator_refresh($feed);
  }
}

function aggregator_update() {
  $result = db_query("SELECT * FROM {feed}");
  while ($feed = db_fetch_array($result)) {
    aggregator_refresh($feed);
  }
}

function theme_aggregator_format_item($item, $feed = 0) {
  global $user;

  if ($user->uid && module_exist("blog") && user_access("maintain personal blog")) {
    $output .= "<div class=\"icon\">". l("<img src=\"". theme("image", "blog.gif") ."\" alt=\"". t("blog it") ."\" title=\"". t("blog it") ."\" />", "node/add/blog", array("title" => t("Comment on this news item in your personal blog."), "class" => "blog-it"), "iid=$item->iid") ."</div>";
  }

  // external link
  $output .= "<a href=\"$item->link\">$item->title</a>";

  return $output;
}

function aggregator_bundle_block($attributes) {
  if ($attributes) {
    $keys = explode(",", $attributes);
    foreach ($keys as $key) {
      $where[] = "attributes LIKE '%". check_query(trim($key)) ."%'";
    }

    $result = db_query_range("SELECT * FROM {item} WHERE ". implode(" OR ", $where) ." ORDER BY timestamp DESC", 0, variable_get("aggregator_block_limit", 15));
  }

  $items = array();
  while ($item = db_fetch_object($result)) {
    $items[] = theme("aggregator_format_item", $item);
  }

  return theme("item_list", $items);
}

function aggregator_feed_block($feed) {
  $result = db_query_range("SELECT * FROM {item} WHERE fid = %d ORDER BY timestamp DESC ", $feed->fid, 0, variable_get("aggregator_block_limit", 15));

  $items = array();
  while ($item = db_fetch_object($result)) {
    $items[] = theme("aggregator_format_item", $item);
  }

  return theme("item_list", $items);
}

function aggregator_block($op, $delta) {
  if (user_access('access news feeds')) {
    if ($op == "list") {
      $result = db_query("SELECT * FROM {bundle} ORDER BY title");
      while ($bundle = db_fetch_object($result)) {
        $block["bundle:$bundle->bid"]["info"] = "$bundle->title bundle";
      }

      $result = db_query("SELECT * FROM {feed} ORDER BY fid");
      while ($feed = db_fetch_object($result)) {
        $block["feed:$feed->fid"]["info"] = "$feed->title feed";
      }

      return $block;
    }
    else {
      list($type, $id) = split(":", $delta);
      switch ($type) {
        case "feed":
          $feed = db_fetch_object(db_query("SELECT * FROM {feed} WHERE fid = %d", $id));
          $block["subject"] = $feed->title;
          $block["content"] .= aggregator_feed_block($feed) ."<div class=\"more-link\">".  l(t("more"), "aggregator/feed/$feed->fid", array("title" => t("View this feed's recent news."))) ."</div>";
          break;
        case "bundle":
          $bundle = db_fetch_object(db_query("SELECT * FROM {bundle} WHERE bid = %d", $id));
          $block["subject"] = $bundle->title;
          $block["content"] .= aggregator_bundle_block($bundle->attributes) ."<div class=\"more-link\">". l(t("more"), "aggregator/bundle/$bundle->bid", array("title" => t("View this bundle's recent news."))) ."</div>";
          break;
      }

      return $block;
    }
  }
}

function aggregator_get_bundles($attributes = 0) {
  $block = array();

  $result = db_query("SELECT * FROM {bundle} ORDER BY title");
  while ($bundle = db_fetch_object($result)) {
    $block["bundle:$bundle->bid"]["subject"] = $bundle->title;
    $block["bundle:$bundle->bid"]["content"] = aggregator_bundle_block($bundle->attributes) ."<div class=\"more-link\">". l(t("more"), "aggregator/bundle/$bundle->bid", array("title" => t("View this bundle's recent news."))) ."</div>";
    $block["bundle:$bundle->bid"]["info"] = "$bundle->title bundle";
  }

  return $block;
}

function aggregator_get_feeds($attributes = 0) {
  $block = array();

  $result = db_query("SELECT * FROM {feed} ORDER BY fid");
  while ($feed = db_fetch_object($result)) {
    $block["feed:$feed->fid"]["subject"] = $feed->title;
    $block["feed:$feed->fid"]["content"] = aggregator_feed_block($feed) ."<div class=\"more-link\">". l(t("more"), "aggregator/feed/$feed->fid", array("title" => t("View this feed's recent news."))) ."</div>";
    $block["feed:$feed->fid"]["info"] = "$feed->title feed";
  }

  return $block;
}

function aggregator_remove($feed) {
  db_query("DELETE FROM {item} WHERE fid = %d", $feed["fid"]);
  return t("removed news items from '%site'.", array("%site" => $feed["title"]));
}

// Call-back function used by XML parser:
function aggregator_element_start($parser, $name, $attributes) {
  global $item, $element, $tag;

  switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
      $element = $name;
      break;
    case "ITEM":
      $element = $name;
      $item += 1;
  }

  $tag = $name;
}

// Call-back function used by XML parser:
function aggregator_element_end($parser, $name) {
  global $element;

  switch ($name) {
    case "IMAGE":
    case "TEXTINPUT":
    case "ITEM":
      $element = "";
  }
}

// Call-back function used by XML parser:
function aggregator_element_data($parser, $data) {
  global $channel, $element, $items, $item, $tag;

  switch ($element) {
    case "ITEM":
      $items[$item][$tag] .= $data;
      break;
    case "IMAGE":
    case "TEXTINPUT":
      /*
      ** The sub-elements "image" and "textinput" are not supported
      ** but we have recognize them or their content will end up in
      ** the items-array.
      */
      break;
    default:
      $channel[$tag] .= $data;
  }
}

function aggregator_refresh($feed) {
  // Generate conditional GET headers.
  $headers = array();
  if ($feed['etag']) {
    $headers['If-None-Match'] = $feed['etag'];
  }
  if ($feed['modified']) {
    $headers['If-Modified-Since'] = gmdate("D, d M Y H:i:s", $feed['modified']) ." GMT";
  }

  // Request feed.
  $result = drupal_http_request($feed['url'], $headers);

  // Process HTTP reponse code.
  switch ($result->code) {
    case 304:
      db_query("UPDATE {feed} SET checked = %d WHERE fid = %d", time(), $feed['fid']);
      return t("no new syndicated content from '%site'.", array('%site' => $feed['title']));
    case 301:
      $feed['url'] = $result->redirect_url;
      watchdog('special', "aggregator: updated URL for feed '$feed[title]' to $feed[url]");
    case 200:
    case 302:
    case 307:
      // Filter the input data:
      if (!valid_input_data($result->data)) {
        return t("failed to parse RSS feed '%site': suspicious input data.", array("%site" => $feed["title"]));
      }

      $channel = aggregator_parse_feed($result->data, $feed);

      if (is_array($channel)) {
        if ($result->headers['Last-Modified']) {
          $modified = strtotime($result->headers['Last-Modified']);
        }

        db_query("UPDATE {feed} SET url = '%s', checked = %d, link = '%s', description = '%s', etag = '%s', modified = %d WHERE fid = %d", $feed['url'], time(), $channel["LINK"], $channel["DESCRIPTION"], $result->headers['ETag'], $modified, $feed["fid"]);

        return t("syndicated content from '%site'.", array("%site" => $feed["title"]));
      }
      else {
        return $channel;
      }
    default:
      return t("failed to parse RSS feed '%site': %error.", array('%site' => $feed['title'], '%error' => $result->code .' '. $result->error));
  }
}

function aggregator_parse_feed(&$data, $feed) {
  global $items, $channel;

  // Unset the global variables before we use them:
  unset($GLOBALS["element"], $GLOBALS["item"], $GLOBALS["tag"]);
  $items = array();
  $channel = array();

  // parse the data:
  $xml_parser = drupal_xml_parser_create($data);
  xml_set_element_handler($xml_parser, "aggregator_element_start", "aggregator_element_end");
  xml_set_character_data_handler($xml_parser, "aggregator_element_data");

  if (!xml_parse($xml_parser, $data, 1)) {
    return t("failed to parse RSS feed '%site': %error at line %line.", array("%site" => $feed["title"], "%error" => xml_error_string(xml_get_error_code($xml_parser)), "%line" => xml_get_current_line_number($xml_parser)));
  }
  xml_parser_free($xml_parser);

  // initialize the translation table:
  $tt = array_flip(get_html_translation_table(HTML_ENTITIES));
  $tt["&apos;"] = "'";

  /*
  ** We reverse the array such that we store the first item last,
  ** and the last item first.  In the database, the newest item
  ** should be at the top.
  */

  $items = array_reverse($items);

  foreach ($items as $item) {
    unset($title, $link, $author, $description);

    // Prepare the item:
    foreach ($item as $key => $value) {
      $item[$key] = filter_default(strtr(trim($value), $tt));
    }

    if ($item["TITLE"]) {
      $title = $item["TITLE"];
    }
    else {
      /*
       ** Use up to 40 characters of the description, ending at
       ** word boundary, but don't split potential entities.
       */
      $title = preg_replace('/^(.*)[^\w;&].*?$/', "\\1", substr($item["DESCRIPTION"], 0, 40));
    }

    if ($item["LINK"]) {
      $link = $item["LINK"];
    }
    elseif ($item["GUID"] && (strncmp($item["GUID"], "http://", 7) == 0)) {
      $link = $item["GUID"];
    }
    else {
      $link = $feed["link"];
    }

    if (!$timestamp = strtotime($item['PUBDATE'])) {
      $timestamp = time();
    }

    /*
    ** Save this item.  Try to avoid duplicate entries as much as
    ** possible.  If we find a duplicate entry, we resolve it and
    ** pass along it's ID such that we can update it if needed.
    */

    if ($link && $link != $feed["link"] && $link != $feed["url"]) {
      $entry = db_fetch_object(db_query("SELECT iid FROM {item} WHERE fid = %d AND link = '%s'", $feed["fid"], $link));
    }
    else {
      $entry = db_fetch_object(db_query("SELECT iid FROM {item} WHERE fid = %d AND title = '%s'", $feed["fid"], $title));
    }

    aggregator_save_item(array('iid' => $entry->iid, 'fid' => $feed["fid"], 'timestamp' => $timestamp, 'title' => $title, 'link' => $link, 'author' => $item["AUTHOR"], 'description' => $item["DESCRIPTION"], 'attributes' => $feed["attributes"]));
  }
  /*
  ** Remove all the old, expired items:
  */

  unset($items);

  $result = db_query("SELECT iid FROM {item} WHERE fid = %d ORDER BY timestamp", $feed["fid"]);

  while ($item = db_fetch_object($result)) {
    $items[] = "iid = '$item->iid'";
  }

  if (sizeof($items) > 50) {
    db_query("DELETE FROM {item} WHERE ". implode(" OR ", array_slice($items, 0, - 50)));
  }

  cache_clear_all();

  return $channel;
}

function aggregator_save_item($edit) {
  if ($edit["iid"] && $edit["title"]) {
    db_query("UPDATE {item} SET title = '%s', link = '%s', author = '%s', description = '%s', attributes = '%s' WHERE iid = %d", $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], $edit["iid"]);
  }
  else if ($edit["iid"]) {
    db_query("DELETE FROM {item} WHERE iid = %d", $edit["iid"]);
  }
  else if ($edit["title"] && $edit["link"]) {
    db_query("INSERT INTO {item} (fid, title, link, author, description, attributes, timestamp) VALUES (%d, '%s', '%s', '%s', '%s', '%s', %d)", $edit["fid"], $edit["title"], $edit["link"], $edit["author"], $edit["description"], $edit["attributes"], $edit["timestamp"]);
  }
}

function aggregator_form_bundle($edit = array()) {
  $form = form_textfield(t("Title"), "title", $edit["title"], 50, 64, t("The name of the bundle."));
  $form .= form_textfield(t("Attributes"), "attributes", $edit["attributes"], 50, 128, t("A comma-separated list of keywords describing the bundle."));

  $form .= form_submit(t("Submit"));

  if ($edit["bid"]) {
    $form .= form_submit(t("Delete"));
    $form .= form_hidden("bid", $edit["bid"]);
  }

  return form($form);
}

function aggregator_save_bundle($edit) {
  if ($edit["bid"] && $edit["title"]) {
    db_query("UPDATE {bundle} SET title = '%s', attributes = '%s' WHERE bid = %d", $edit["title"], $edit["attributes"], $edit["bid"]);
  }
  else if ($edit["bid"]) {
    db_query("DELETE FROM {bundle} WHERE bid = %d", $edit["bid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("{bundle}_bid");
    db_query("INSERT INTO {bundle} (bid, title, attributes) VALUES (%d, '%s', '%s')", $next_id, $edit["title"], $edit["attributes"]);
  }
}

function aggregator_form_feed($edit = array()) {
  $period = array(900 => format_interval(900), 1800 => format_interval(1800), 3600 => format_interval(3600), 7200 => format_interval(7200), 10800 => format_interval(10800), 21600 => format_interval(21600), 32400 => format_interval(32400), 43200 => format_interval(43200), 64800 => format_interval(64800), 86400 => format_interval(86400), 172800 => format_interval(172800), 259200 => format_interval(259200), 604800 => format_interval(604800), 1209600 => format_interval(1209600), 2419200 => format_interval(2419200));

  if ($edit["refresh"] == "") {
    $edit["refresh"] = 3600;
  }

  $form .= form_textfield(t("Title"), "title", $edit["title"], 50, 64, t("The name of the feed; typically the name of the web site you syndicate content from."));
  $form .= form_textfield(t("URL"), "url", $edit["url"], 50, 128, t("The fully-qualified URL of the feed."));
  $form .= form_textfield(t("Attributes"), "attributes", $edit["attributes"], 50, 128, t("A comma-separated list of keywords describing the feed."));
  $form .= form_select(t("Update interval"), "refresh", $edit["refresh"], $period, t("The refresh interval indicating how often you want to update this feed.  Requires crontab."));

  $form .= form_submit(t("Submit"));

  if ($edit["fid"]) {
    $form .= form_submit(t("Delete"));
    $form .= form_hidden("fid", $edit["fid"]);
  }

  return form($form);
}

function aggregator_save_feed($edit) {
  if ($edit["fid"] && $edit["title"]) {
    db_query("UPDATE {feed} SET title = '%s', url = '%s', attributes = '%s', refresh = %d WHERE fid = %d", $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"], $edit["fid"]);
    db_query("DELETE FROM {item} WHERE fid = %d", $edit["fid"]);
  }
  else if ($edit["fid"]) {
    db_query("DELETE FROM {feed} WHERE fid = %d", $edit["fid"]);
    db_query("DELETE FROM {item} WHERE fid = %d", $edit["fid"]);
  }
  else if ($edit["title"]) {
    // a single unique id for bundles and feeds, to use in blocks
    $next_id = db_next_id("{feed}_fid");
    db_query("INSERT INTO {feed} (fid, title, url, attributes, refresh) VALUES (%d, '%s', '%s', '%s', %d)", $next_id, $edit["title"], $edit["url"], $edit["attributes"], $edit["refresh"]);
  }
}

function aggregator_save_attributes($edit) {
  foreach ($edit as $iid => $value) {
    db_query("UPDATE {item} SET attributes = '%s' WHERE iid = %d", $value, $iid);
  }
  return t("attributes has been saved");
}

function aggregator_get_feed($fid) {
  return db_fetch_array(db_query("SELECT * FROM {feed} WHERE fid = %d", $fid));
}

function aggregator_get_bundle($bid) {
  return db_fetch_array(db_query("SELECT * FROM {bundle} WHERE bid = %d", $bid));
}

function aggregator_view() {
  $result = db_query("SELECT f.*, COUNT(i.iid) AS items FROM {feed} f LEFT JOIN {item} i ON f.fid = i.fid GROUP BY f.fid, f.title, f.url, f.refresh, f.checked, f.attributes, f.link, f.description ORDER BY f.title");

  $output .= "<h3>". t("Feed overview") ."</h3>";

  $header = array(t("title"), t("attributes"), t("items"), t("last update"), t("next update"), array("data" => t("operations"), "colspan" => 3));
  $rows = array();
  while ($feed = db_fetch_object($result)) {
    $rows[] = array($feed->title, $feed->attributes, format_plural($feed->items, "1 item", "%count items"), ($feed->checked ? t("%time ago", array("%time" => format_interval(time() - $feed->checked))) : t("never")), ($feed->checked ? t("%time left", array("%time" => format_interval($feed->checked + $feed->refresh - time()))) : t("never")), l(t("edit feed"), "admin/node/syndication/news/edit/feed/$feed->fid"), l(t("remove items"), "admin/node/syndication/news/remove/$feed->fid"), l(t("update items"), "admin/node/syndication/news/update/$feed->fid"));
  }
  $output .= theme("table", $header, $rows);

  $result = db_query("SELECT * FROM {bundle} ORDER BY title");

  $output .= "<h3>". t("Bundle overview") ."</h3>";

  $header = array(t("title"), t("attributes"), t("operations"));
  $rows = array();
  while ($bundle = db_fetch_object($result)) {
    $rows[] = array($bundle->title, $bundle->attributes, l(t("edit bundle"), "admin/node/syndication/news/edit/bundle/$bundle->bid"));
  }
  $output .= theme("table", $header, $rows);

  return $output;
}

function aggregator_tag() {
  $result = db_query_range("SELECT i.*, f.title AS feed FROM {item} i INNER JOIN {feed} f ON i.fid = f.fid ORDER BY i.timestamp DESC", 0, 50);

  $header = array(t("date"), t("feed"), t("news item"));
  while ($item = db_fetch_object($result)) {
    $rows[] = array(array("data" => format_date($item->timestamp, "small"), "nowrap" => "nowrap", "valign" => "top"), array("data" => l($item->feed, "admin/node/syndication/news/edit/feed/$item->fid"), "valign" => "top"), "<a href=\"$item->link\">$item->title</a>". ($item->description ? "<br /><small><i>$item->description</i></small>" : "") ."<br /><input type=\"text\" name=\"edit[$item->iid]\" value=\"". check_form($item->attributes) ."\" size=\"50\" />");
  }

  $output .= theme("table", $header, $rows);
  $output .= "<input type=\"submit\" name=\"op\" value=\"". t("Save attributes") ."\" />\n";

  return form($output);
}

function aggregator_admin() {
  $edit = $_POST["edit"];

  if (user_access("administer news feeds")) {

    switch ($_POST["op"] ? $_POST["op"] : arg(4)) {
      case "add":
        if (arg(5) == "bundle") {
          $output = aggregator_form_bundle();
        }
        else {
          $output = aggregator_form_feed();
        }
        break;
      case "edit":
        if (arg(5) == "bundle") {
          $output = aggregator_form_bundle(aggregator_get_bundle(arg(6)));
        }
        else {
          $output = aggregator_form_feed(aggregator_get_feed(arg(6)));
        }
        break;
      case "remove":
        drupal_set_message(aggregator_remove(aggregator_get_feed(arg(5))));
        $output .= aggregator_view();
        break;
      case "update":
        drupal_set_message(aggregator_refresh(aggregator_get_feed(arg(5))));
        $output .= aggregator_view();
        break;
      case "tag":
        $output = aggregator_tag();
        break;
      case t("Save attributes"):
        drupal_set_message(aggregator_save_attributes($edit));
        $output .= aggregator_tag();
        break;
      case t("Delete"):
        $edit["title"] = 0;
        // fall through:
      case t("Submit"):
        if (arg(5) == "bundle") {
          drupal_set_message(aggregator_save_bundle($edit));
        }
        else {
          drupal_set_message(aggregator_save_feed($edit));
        }
        // fall through:
      default:
        $output .=  aggregator_view();
    }
    print theme("page", $output);
  }
  else {
    print theme("page", message_access());
  }
}

function aggregator_page_last() {
  $result = db_query_range("SELECT i.*, f.title AS ftitle, f.link AS flink FROM {item} i INNER JOIN {feed} f ON i.fid = f.fid ORDER BY i.timestamp DESC", 0, variable_get("aggregator_page_limit", 75));

  $output = "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    $links = array(format_date($item->timestamp));
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = l(t("feed"), "aggregator/feed/$item->fid", array("title" => t("Read more syndicated news from this feed.")));

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". l($item->ftitle, "aggregator/feed/$item->fid", array("title" => t("View more information about this feed."))) ."</td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }
  }
  $output .= "</table>\n";

  print theme("page", $output);
}

function aggregator_page_feed($fid) {
  $feed = db_fetch_object(db_query("SELECT * FROM {feed} WHERE fid = %d", $fid));

  $header = "<p><strong>". t("Website") .":</strong><div style=\"margin-left: 20px;\"><a href=\"$feed->link\">$feed->link</a></div></p>";
  $header .= "<p><strong>". t("Description") .":</strong><div style=\"margin-left: 20px;\">$feed->description</div></p>";
  $header .= "<p><strong>". t("Last update") .":</strong><div style=\"margin-left: 20px; text-align: right;\">". t("%time ago", array("%time" => format_interval(time() - $feed->checked))) ." <a href=\"$feed->url\"><img src=\"". theme("image", "xml.gif") ."\" width=\"36\" height=\"14\" style=\"border: 0px;\" alt=\"\" title=\"\" /></a><br /><br /></div></p>\n";

  $result = db_query_range("SELECT * FROM {item} WHERE fid = %d ORDER BY timestamp DESC", $fid, 0, variable_get("aggregator_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    $links = array();
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a></td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }
    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }
  }
  $output .= "</table>\n";

  print theme("header");
  print theme("box", $feed->title, $header);
  print theme("box", t("Latest news"), $output);
  print theme("footer");
}

function aggregator_page_bundle($bid) {
  $bundle = db_fetch_object(db_query("SELECT * FROM {bundle} WHERE bid = %d", $bid));

  $header .= "<p><strong>". t("Website") .":</strong><div style=\"margin-left: 20px;\">". l($bundle->title, "aggregator/bundle/$bundle->bid") ."</div></p>";
  $header .= "<p><strong>". t("Description") .":</strong><div style=\"margin-left: 20px;\">". t("A composite news feed about") ." $bundle->attributes.</div></p>";

  $keys = explode(",", $bundle->attributes);
  foreach ($keys as $key) $where[] = "i.attributes LIKE '%". trim($key) ."%'";
  $result = db_query_range("SELECT i.*, f.title AS ftitle, f.link AS flink FROM {item} i, {feed} f WHERE (". implode(" OR ", $where) .") AND i.fid = f.fid ORDER BY timestamp DESC", 0, variable_get("aggregator_page_limit", 75));

  $output .= "<table border=\"0\" cellpadding=\"4\" cellspacing=\"2\">";
  while ($item = db_fetch_object($result)) {
    if (module_exist("blog") && user_access("maintain personal blog")) {
      $links[] = l(t("blog it"), "node/add/blog", array("title" => t("Comment on this news item in your personal blog.")), "iid=$item->iid");
    }
    $links[] = l(t("feed"), "aggregator/feed/$item->fid", array("title" => t("Read more syndicated news from this feed.")));
    $links[] = "<a href=\"$item->link\">". t("visit") ."</a>";

    if ($item->link) {
      $output .= "<tr><td><a href=\"$item->link\">$item->title</a> &middot; ". l($item->ftitle, "aggregator/feed/$item->fid", array("title" => t("View more information about this feed."))) ."</td><td style=\"text-align: right; vertical-align: top;\">". theme("links", $links) ."</td></tr>\n";
    }

    if ($item->description) {
      $output .= "<tr><td colspan=\"2\"><div style=\"margin-left: 20px;\">$item->description</div><br /></td></tr>";
    }

    unset($links);
  }
  $output .= "</table>\n";

  print theme("header");
  print theme("box", $bundle->title, $header);
  print theme("box", t("Latest news"), $output);
  print theme("footer");
}

function aggregator_page_sources() {
  $result = db_query("SELECT * FROM {feed} ORDER BY title");

  while ($feed = db_fetch_object($result)) {
    $output .= l($feed->title, "aggregator/feed/$feed->fid");
    $output .= "<div style=\"margin-left: 20px;\">$feed->description</div><br />";
  }

  $output .= "<div style=\"xml-icon\">". l("<img src=\"". theme("image", "xml.gif") ."\" width=\"36\" height=\"14\" style=\"border: 0px;\" />", "aggregator/opml", array("title" => t("View the list of syndicated web sites in XML format."))) ."</div><br />";

  print theme("page", $output);
}

function aggregator_page_opml() {
  $result = db_query("SELECT * FROM {feed} ORDER BY title");

  $output = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n";
  $output .= "<opml version=\"1.1\">\n";
  $output .= "<head>\n";
  $output .= "<title>". drupal_specialchars(variable_get('site_name', 'Drupal')) ."</title>\n";
  $output .= "<dateModified>". gmdate('r') ."</dateModified>\n";
  $output .= "</head>\n";
  $output .= "<body>\n";

  while ($feed = db_fetch_object($result)) {
    $output .= '<outline text="'. drupal_specialchars($feed->title) .'" xmlUrl="'. drupal_specialchars($feed->url) ."\" />\n";
  }

  $output .= "</body>\n";
  $output .= "</opml>\n";

  header("Content-Type: text/xml");

  print $output;
}

function aggregator_page_bundles() {
  aggregator_page_blocks(aggregator_get_bundles());
}

function aggregator_page_feeds() {
  aggregator_page_blocks(aggregator_get_feeds());
}

function aggregator_page_blocks($blocks) {
  print theme("header");
  print "<table cellpadding=\"0\" cellspacing=\"5\" border=\"0\" style=\"width: 100%;\">\n";
  print " <tr>\n";

  for ($t = 0; $t < 3; $t++) {
    $i = 1;
    print "  <td style=\"vertical-align: top; width: 33%;\">\n";
    while ($block = each($blocks)) {
      print theme("box", $block["value"]["subject"], $block["value"]["content"]);
      if ($i == ceil(count($blocks) / 3)) {
        break;
      }
      $i++;
    }
    print "  </td>\n";
  }

  print " </tr>\n";
  print "</table>\n";
  print theme("footer");
}

function aggregator_page() {
  if (user_access("access news feeds")) {
    switch (arg(1)) {
      case "feed":
        aggregator_page_feed(arg(2));
        break;
      case "bundle":
        aggregator_page_bundle(arg(2));
        break;
      case "feeds":
        aggregator_page_feeds();
        break;
      case "bundles":
        aggregator_page_bundles();
        break;
      case "sources":
        aggregator_page_sources();
        break;
      case "opml":
        aggregator_page_opml();
        break;
      default:
        aggregator_page_last();
    }
  }
}

?>
